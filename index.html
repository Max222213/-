<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ПУДЖ РАННЕР</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    background: #222;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: Arial, sans-serif;
  }
  
  #game-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    max-width: 500px;
    max-height: 800px;
    overflow: hidden;
  }
  
  #background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }
  
  #game-canvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(201, 245, 217, 0.9);
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    z-index: 2;
  }
  
  #score {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #fff;
    text-shadow: 2px 2px 4px #000;
    z-index: 3;
    background: rgba(0,0,0,0.5);
    padding: 10px 15px;
    border-radius: 10px;
  }
  
  #pudge {
    position: absolute;
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    text-shadow: 2px 2px 4px #000;
    pointer-events: none;
    z-index: 3;
    background: rgba(0,0,0,0.7);
    padding: 5px 10px;
    border-radius: 8px;
  }
  
  #controls {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    text-align: center;
    z-index: 3;
    background: rgba(0,0,0,0.7);
    padding: 15px;
    border-radius: 15px;
    font-size: 16px;
  }
  
  /* Адаптация для разных размеров экрана */
  @media (max-height: 700px) {
    #game-canvas {
      width: 90vw !important;
      height: 200px !important;
    }
    #controls {
      bottom: 15px;
      font-size: 14px;
    }
  }
  
  @media (max-width: 400px) {
    #score {
      font-size: 24px;
      top: 10px;
      right: 10px;
    }
    #controls {
      font-size: 14px;
      padding: 10px;
    }
  }
</style>
</head>
<body>
<div id="game-container">
  <img id="background" src="img/bg1.png" alt="Background">
  <canvas id="game-canvas"></canvas>
  <div id="score">00000</div>
  <div id="pudge">ПУДЖ</div>
  <div id="controls">Тапни по экрану чтобы прыгать!</div>
</div>

<script>
// ========== TELEGRAM WEB APP INTEGRATION ==========
let tg = window.Telegram?.WebApp;
let isTelegram = false;

if (tg) {
    isTelegram = true;
    tg.expand();
    tg.enableClosingConfirmation();
    tg.setHeaderColor('#222222');
    tg.backgroundColor = '#222222';
}

/* ---------- настройки ---------- */
const cfg = {
  dragonImg: "img/dragon.png",
  cactusImgs: ["img/cactus1.png", "img/cactus2.png"],
  backgroundImgs: ["img/bg1.png", "img/bg2.png", "img/bg3.png"],
  musicFile: "img/music.mp3",
  gravity: 0.28,
  lift: -15,
  speed: 1.5,
  interval: 200
};

/* ---------- инициализация canvas ---------- */
const cvs = document.getElementById('game-canvas');
const ctx = cvs.getContext('2d');

// Адаптивный размер canvas для вертикального режима
function setupCanvas() {
    const container = document.getElementById('game-container');
    const maxWidth = Math.min(container.clientWidth - 40, 400);
    const maxHeight = Math.min(container.clientHeight * 0.3, 200);
    
    cvs.width = maxWidth;
    cvs.height = maxHeight;
    
    // Обновляем позицию canvas
    cvs.style.width = maxWidth + 'px';
    cvs.style.height = maxHeight + 'px';
}

/* ---------- управление фонами ---------- */
let currentBg = 0;
const bgElement = document.getElementById('background');

function changeBackground() {
    currentBg = (currentBg + 1) % cfg.backgroundImgs.length;
    bgElement.src = cfg.backgroundImgs[currentBg];
}

// Смена фона каждые 10 секунд
setInterval(changeBackground, 10000);

/* ---------- аудио ---------- */
const music = new Audio(cfg.musicFile);
music.loop = true;
music.volume = 0.5;
let musicStarted = false;

function startMusic() {
    if (!musicStarted && music) {
        music.play().catch(e => {
            console.log('Music autoplay blocked');
        });
        musicStarted = true;
    }
}

/* ---------- ресурсы ---------- */
const R = {};
function loadImg(name, src) {
    const i = new Image();
    i.onerror = () => console.log('Error loading:', src);
    i.src = src;
    R[name] = i;
}

// Загрузка всех изображений
loadImg("dragon", cfg.dragonImg);
cfg.cactusImgs.forEach((src, i) => loadImg(`c${i}`, src));
cfg.backgroundImgs.forEach((src, i) => loadImg(`bg${i}`, src));

/* ---------- игровые объекты ---------- */
const dragon = { x: 60, y: 0, w: 44, h: 48, vy: 0, onGround: false };
const obstacles = [];
let frame = 0, score = 0, playing = false, gameOver = false;

/* ---------- управление ---------- */
function jump() {
    startMusic();
    
    if (!playing && !gameOver) {
        playing = true;
        gameOver = false;
        document.getElementById('controls').style.display = 'none';
        loop();
    }
    
    if (dragon.onGround && playing) {
        dragon.vy = cfg.lift;
        dragon.onGround = false;
        
        if (isTelegram && tg.HapticFeedback) {
            tg.HapticFeedback.impactOccurred('light');
        }
    }
}

// Управление для всех платформ
window.addEventListener('keydown', e => {
    if (e.code === 'Space') {
        e.preventDefault();
        jump();
    }
});

window.addEventListener('touchstart', e => {
    e.preventDefault();
    jump();
});

window.addEventListener('mousedown', e => {
    e.preventDefault();
    jump();
});

// Предотвращаем скролл на мобильных
document.addEventListener('touchmove', e => {
    e.preventDefault();
}, { passive: false });

/* ---------- логика игры ---------- */
function update() {
    if (!playing) return;
    
    // гравитация
    if (!dragon.onGround) {
        dragon.vy += cfg.gravity;
        dragon.y += dragon.vy;
    }
    
    // проверка земли
    if (dragon.y + dragon.h >= cvs.height) {
        dragon.y = cvs.height - dragon.h;
        dragon.vy = 0;
        dragon.onGround = true;
    }

    // генерация препятствий
    if (frame % cfg.interval === 0) {
        const i = Math.floor(Math.random() * cfg.cactusImgs.length);
        obstacles.push({
            x: cvs.width,
            w: 20 + Math.random() * 10,
            h: 20 + Math.random() * 15,
            img: R[`c${i}`]
        });
    }
    
    // движение препятствий
    obstacles.forEach(o => o.x -= cfg.speed);
    
    // удаление вышедших за экран препятствий
    while (obstacles.length && obstacles[0].x + obstacles[0].w < 0) {
        obstacles.shift();
    }

    // проверка столкновений
    obstacles.forEach(o => {
        if (dragon.x < o.x + o.w &&
            dragon.x + dragon.w > o.x &&
            dragon.y + dragon.h > cvs.height - o.h) {
            death();
        }
    });

    // обновление счета
    score = Math.floor(frame / 10);
    document.getElementById('score').textContent = String(score).padStart(5, '0');
    
    // обновление позиции текста "ПУДЖ"
    const pudgeElement = document.getElementById('pudge');
    const canvasRect = cvs.getBoundingClientRect();
    pudgeElement.style.left = (canvasRect.left + dragon.x + dragon.w / 2 - 35) + 'px';
    pudgeElement.style.top = (canvasRect.top + dragon.y - 40) + 'px';
    
    frame++;
}

/* ---------- отрисовка ---------- */
function draw() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);

    // земля
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(0, cvs.height - 20, cvs.width, 20);

    // дракон
    if (R.dragon && R.dragon.complete) {
        ctx.drawImage(R.dragon, dragon.x, dragon.y, dragon.w, dragon.h);
    } else {
        ctx.fillStyle = '#333';
        ctx.fillRect(dragon.x, dragon.y, dragon.w, dragon.h);
    }

    // кактусы
    obstacles.forEach(o => {
        if (o.img && o.img.complete) {
            ctx.drawImage(o.img, o.x, cvs.height - o.h, o.w, o.h);
        } else {
            ctx.fillStyle = '#5a5';
            ctx.fillRect(o.x, cvs.height - o.h, o.w, o.h);
        }
    });
    
    // сообщение о Game Over
    if (gameOver) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(0, 0, cvs.width, cvs.height);
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('GAME OVER', cvs.width / 2, cvs.height / 2 - 20);
        ctx.font = '16px Arial';
        ctx.fillText('Счет: ' + score, cvs.width / 2, cvs.height / 2 + 10);
        ctx.fillText('Тапни для рестарта', cvs.width / 2, cvs.height / 2 + 40);
    }
}

function loop() {
    if (playing) {
        update();
        draw();
        requestAnimationFrame(loop);
    }
}

function death() {
    playing = false;
    gameOver = true;
    document.getElementById('controls').style.display = 'block';
    
    if (isTelegram && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('heavy');
    }
    
    draw();
}

function restartGame() {
    obstacles.length = 0;
    frame = 0;
    score = 0;
    dragon.y = cvs.height - dragon.h;
    dragon.vy = 0;
    dragon.onGround = true;
    gameOver = false;
    playing = false;
    
    document.getElementById('score').textContent = '00000';
    document.getElementById('controls').style.display = 'block';
    drawStartScreen();
}

function drawStartScreen() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    
    // земля
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(0, cvs.height - 20, cvs.width, 20);
    
    ctx.fillStyle = '#333';
    ctx.textAlign = 'center';
    ctx.font = 'bold 18px Arial';
    ctx.fillText('Тапни по экрану чтобы начать!', cvs.width / 2, cvs.height / 2);
}

// Обработчик рестарта
cvs.addEventListener('click', function(e) {
    if (gameOver) {
        restartGame();
    }
});

/* ---------- инициализация ---------- */
// Настройка при загрузке и ресайзе
window.addEventListener('load', function() {
    setupCanvas();
    drawStartScreen();
});

window.addEventListener('resize', function() {
    setupCanvas();
    if (!playing && !gameOver) {
        drawStartScreen();
    }
});

// Защита от скролла
document.body.style.overflow = 'hidden';
document.documentElement.style.overflow = 'hidden';
</script>
</body>
</html>
